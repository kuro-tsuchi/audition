<!DOCTYPE html>
<html lang="en-EN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>1. elasticsearch | 努力！奋斗！</title><meta name="description" content="">
    <link rel="preload" href="/audition/assets/js/runtime~app.d53e597b.js" as="script"><link rel="preload" href="/audition/assets/css/styles.81f20975.css" as="style"><link rel="preload" href="/audition/assets/js/812.cf73d600.js" as="script"><link rel="preload" href="/audition/assets/js/app.44937fea.js" as="script">
    <link rel="stylesheet" href="/audition/assets/css/styles.81f20975.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/audition/" class=""><!----><span class="site-name can-hide">努力！奋斗！</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/audition/" class="nav-link" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/java/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/collection" class="nav-link" aria-label="collection"><!--[--><!--]--> collection <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingbasic" class="nav-link" aria-label="multithreadingbasic"><!--[--><!--]--> multithreadingbasic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingadvanced" class="nav-link" aria-label="multithreadingadvanced"><!--[--><!--]--> multithreadingadvanced <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/jvm" class="nav-link" aria-label="jvm"><!--[--><!--]--> jvm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/spring/springboot" class="nav-link" aria-label="springboot"><!--[--><!--]--> springboot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/spring/mybatis" class="nav-link" aria-label="mybatis"><!--[--><!--]--> mybatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/mq/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rabbitmq" class="nav-link" aria-label="rabbitmq"><!--[--><!--]--> rabbitmq <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/kafka" class="nav-link" aria-label="kafka"><!--[--><!--]--> kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rocketmq" class="nav-link" aria-label="rocketmq"><!--[--><!--]--> rocketmq <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/database/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/mysql" class="nav-link" aria-label="mysql"><!--[--><!--]--> mysql <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/redis" class="nav-link" aria-label="redis"><!--[--><!--]--> redis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/elasticsearch" class="nav-link router-link-active" aria-label="elasticsearch"><!--[--><!--]--> elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/distributed/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/zookeeper" class="nav-link" aria-label="zookeeper"><!--[--><!--]--> zookeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/dubbo" class="nav-link" aria-label="dubbo"><!--[--><!--]--> dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/springcloud" class="nav-link" aria-label="springcloud"><!--[--><!--]--> springcloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/additional/network" class="nav-link" aria-label="network"><!--[--><!--]--> network <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/linux" class="nav-link" aria-label="linux"><!--[--><!--]--> linux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/designPattern" class="nav-link" aria-label="designPattern"><!--[--><!--]--> designPattern <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/golang/codingstandard" class="nav-link" aria-label="codingstandard"><!--[--><!--]--> codingstandard <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/concurrency" class="nav-link" aria-label="concurrency"><!--[--><!--]--> concurrency <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/audition/interview/" class="nav-link" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/business/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/audition/" class="nav-link" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/java/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/collection" class="nav-link" aria-label="collection"><!--[--><!--]--> collection <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingbasic" class="nav-link" aria-label="multithreadingbasic"><!--[--><!--]--> multithreadingbasic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingadvanced" class="nav-link" aria-label="multithreadingadvanced"><!--[--><!--]--> multithreadingadvanced <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/jvm" class="nav-link" aria-label="jvm"><!--[--><!--]--> jvm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/spring/springboot" class="nav-link" aria-label="springboot"><!--[--><!--]--> springboot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/spring/mybatis" class="nav-link" aria-label="mybatis"><!--[--><!--]--> mybatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/mq/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rabbitmq" class="nav-link" aria-label="rabbitmq"><!--[--><!--]--> rabbitmq <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/kafka" class="nav-link" aria-label="kafka"><!--[--><!--]--> kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rocketmq" class="nav-link" aria-label="rocketmq"><!--[--><!--]--> rocketmq <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/database/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/mysql" class="nav-link" aria-label="mysql"><!--[--><!--]--> mysql <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/redis" class="nav-link" aria-label="redis"><!--[--><!--]--> redis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/elasticsearch" class="nav-link router-link-active" aria-label="elasticsearch"><!--[--><!--]--> elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/distributed/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/zookeeper" class="nav-link" aria-label="zookeeper"><!--[--><!--]--> zookeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/dubbo" class="nav-link" aria-label="dubbo"><!--[--><!--]--> dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/springcloud" class="nav-link" aria-label="springcloud"><!--[--><!--]--> springcloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/additional/network" class="nav-link" aria-label="network"><!--[--><!--]--> network <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/linux" class="nav-link" aria-label="linux"><!--[--><!--]--> linux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/designPattern" class="nav-link" aria-label="designPattern"><!--[--><!--]--> designPattern <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/golang/codingstandard" class="nav-link" aria-label="codingstandard"><!--[--><!--]--> codingstandard <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/concurrency" class="nav-link" aria-label="concurrency"><!--[--><!--]--> concurrency <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/audition/interview/" class="nav-link" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/business/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">database</p><ul class=""><li><!--[--><a href="/audition/database/distributed.html" class="nav-link sidebar-item" aria-label="1. interview"><!--[--><!--]--> 1. interview <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/audition/database/mysql.html" class="nav-link sidebar-item" aria-label="1. mysql"><!--[--><!--]--> 1. mysql <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/audition/database/redis.html" class="nav-link sidebar-item" aria-label="1. redis"><!--[--><!--]--> 1. redis <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="1. elasticsearch"><!--[--><!--]--> 1. elasticsearch <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-1-定义" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.1. 定义"><!--[--><!--]--> 1.1. 定义 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-2-elasticsearch-的基本概念" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.2. Elasticsearch 的基本概念"><!--[--><!--]--> 1.2. Elasticsearch 的基本概念 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-3-倒排索引-lucene-索引底层" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.3. 倒排索引(Lucene 索引底层)"><!--[--><!--]--> 1.3. 倒排索引(Lucene 索引底层) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-4-使用场景" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.4. 使用场景"><!--[--><!--]--> 1.4. 使用场景 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-5-ik-分词器" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.5. ik 分词器"><!--[--><!--]--> 1.5. ik 分词器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-6-rest-风格说明" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.6. Rest 风格说明"><!--[--><!--]--> 1.6. Rest 风格说明 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-7-springboot-使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.7. springboot 使用"><!--[--><!--]--> 1.7. springboot 使用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-8-为什么要使用elasticsearch" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.8. 为什么要使用Elasticsearch?"><!--[--><!--]--> 1.8. 为什么要使用Elasticsearch? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-9-es-的写入流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.9. ES 的写入流程"><!--[--><!--]--> 1.9. ES 的写入流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-10-es-的更新和删除流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.10. ES 的更新和删除流程"><!--[--><!--]--> 1.10. ES 的更新和删除流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-11-es-的搜索流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.11. ES 的搜索流程"><!--[--><!--]--> 1.11. ES 的搜索流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-12-在并发情况下-elasticsearch如果保证读写一致" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.12. 在并发情况下,Elasticsearch如果保证读写一致?"><!--[--><!--]--> 1.12. 在并发情况下,Elasticsearch如果保证读写一致? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-13-es-的性能优化-深度分页与滚动搜索-scroll" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.13. ES 的性能优化,  深度分页与滚动搜索 scroll"><!--[--><!--]--> 1.13. ES 的性能优化,  深度分页与滚动搜索 scroll <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-14-es的数据类型" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.14. es的数据类型"><!--[--><!--]--> 1.14. es的数据类型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-15-搜索的整体技术架构" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.15. 搜索的整体技术架构"><!--[--><!--]--> 1.15. 搜索的整体技术架构 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-16-1设计阶段调优" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.16. 1设计阶段调优"><!--[--><!--]--> 1.16. 1设计阶段调优 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-17-写入调优" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.17. 写入调优"><!--[--><!--]--> 1.17. 写入调优 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-18-查询调优" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.18. 查询调优"><!--[--><!--]--> 1.18. 查询调优 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-19-elasticsearch-对于大数据量-上亿量级-的聚合如何实现" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.19. Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？"><!--[--><!--]--> 1.19. Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/database/elasticsearch.html#_1-20-es-在数据量很大的情况下-数十亿级别-如何提高查询效率" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.20. ES 在数据量很大的情况下（数十亿级别）如何提高查询效率？"><!--[--><!--]--> 1.20. ES 在数据量很大的情况下（数十亿级别）如何提高查询效率？ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_1-elasticsearch" tabindex="-1"><a class="header-anchor" href="#_1-elasticsearch" aria-hidden="true">#</a> 1. elasticsearch</h1><p><a href="https://www.kuangstudy.com/bbs/1354069127022583809" target="_blank" rel="noopener noreferrer">https://www.kuangstudy.com/bbs/1354069127022583809<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h2 id="_1-1-定义" tabindex="-1"><a class="header-anchor" href="#_1-1-定义" aria-hidden="true">#</a> 1.1. 定义</h2><p>ELK 是Elasticsearch,Logstash, Kibana 三大开源框架首字母大写简称.市面上也被成为 Elastic Stack.</p><ol><li>Elasticsearch 是基于 Lucene 的 Restful 的分布式实时全文搜索引擎,每个字段都被索引并可被搜索,可以快速存储,搜索,分析海量的数据, ES 是 面向文档的,一切都是 JSON</li><li>Kibana 可以将 elasticsearch 的数据通过友好的页面展示出来 ,提供实时分析的功能.</li><li>Logstash 是 ELK 的中央数据流引擎,用于从不同目标(文件/数据存储/MQ)收集的不同格式数据,经过过滤后支持输出到不同目的地(文件/MQ/redis/elasticsearch/kafka 等).</li></ol><p><img src="/audition/assets/img/1646090458425.5f2d6ad7.png" alt="picture 1"></p><p>收集清洗数据(Logstash) ==&gt; 搜索,存储(ElasticSearch) ==&gt; 展示(Kibana)</p><h2 id="_1-2-elasticsearch-的基本概念" tabindex="-1"><a class="header-anchor" href="#_1-2-elasticsearch-的基本概念" aria-hidden="true">#</a> 1.2. Elasticsearch 的基本概念</h2><ol><li>index 索引:索引是文档的集合, 索引是存在数据的地方,包含了一堆有相似结构的文档数据.</li><li>type 类型: type 是 index 中的一个逻辑数据分类</li><li>document 文档:ES 中的每个文档可以有不同的字段,但是对于通用字段应该具有相同的数据类型,文档是 es 中的最小数据单元,可以认为一个文档就是一条记录.</li><li>Field 字段:Field 是 Elasticsearch 的最小单位,一个 document 里面有多个 field</li><li>shard 分片: 当有大量的文档时,由于内存的限制,磁盘处理能力不足,无法足够快的响应客户端的请求等, es 可以将一个索引中的数据切分为多个 shard,分布在多台服务器上存储.有了 shard 就可以横向扩展,存储更多数据,让搜索和分析等操作分布到多台服务器上去执行,提升吞吐量和性能.</li><li>replic 副本: 为提高查询吞吐量或实现高可用性,可以使用分片副本.replica 可以在 shard 故障时提供备用服务,保证数据不丢失,多个 replica 还可以提升搜索操作的吞吐量和性能.</li><li>集群: 一个或多个节点(服务器)的集合,它们共同保存您的整个数据,并提供跨所有节点的联合索引和搜索功能.集群由唯一名称标识,默认情况下为&quot;elasticsearch&quot;,为了处理大型数据集,实现容错和高可用性</li><li>节点: 形成集群的每个服务器称为节点.它存储数据并参与集群索引和搜索功能.</li></ol><h2 id="_1-3-倒排索引-lucene-索引底层" tabindex="-1"><a class="header-anchor" href="#_1-3-倒排索引-lucene-索引底层" aria-hidden="true">#</a> 1.3. 倒排索引(Lucene 索引底层)</h2><p>在搜索引擎中,每个文档都有一个对应的文档 ID,文档内容被表示为一系列关键词的集合. 某个文档经过分词,提取了多个关键词,每个关键词都会记录它在文档中出现的次数和出现位置.那么,倒排索引就是关键词到文档 ID 的映射,每个关键词都对应着一系列的文档,这些文档中都出现了该关键词.有了倒排索引,搜索引擎可以很方便地响应用户的查询.</p><p><img src="/audition/assets/img/1646448860495.27cdc9ea.png" alt="picture 1"></p><h2 id="_1-4-使用场景" tabindex="-1"><a class="header-anchor" href="#_1-4-使用场景" aria-hidden="true">#</a> 1.4. 使用场景</h2><ol><li>维基百科,类似百度百科,全文检索,高亮,搜索推荐</li><li>电商网站,检索商品</li><li>日志数据分析, logstash 采集日志, ES 进行复杂的数据分析, ELK 技术 ,elasticsearch+logstash+kibana</li><li>商品价格监控网站,用户设定某商品的价格阈值,当低于该阈值的时候,发送通知消息给用户,比如说订阅牙膏的监控,如果高露洁牙膏的家庭套装低于 50 块钱,就通知我,我就去买</li><li>BI 系统,商业智能, Business Intelligence.比如说有个大型商场集团,BI ,分析一下某某区域最近 3 年的用户消费 金额的趋势以及用户群体的组成构成,产出相关的数张报表, 某地区,最近 3 年,每年消费金额呈现 100%的增长,而且用户群体 85%是高级白领, 开-个新商场.ES 执行数据分析和挖掘, Kibana 进行数据可视化</li><li>国内:站内搜索(电商,招聘,门户,等等),IT 系统搜索(OA,CRM,ERP,等等),数据分析(ES热门的一一个使用场景)</li></ol><h2 id="_1-5-ik-分词器" tabindex="-1"><a class="header-anchor" href="#_1-5-ik-分词器" aria-hidden="true">#</a> 1.5. ik 分词器</h2><p>IK 分词器是中文分词器, 把一段中文或者别的划分成一个个的关键字 , 在搜索时候会把自己的信息进行分词,会把数据库中或者索引库中的数据进行分词,然后进行一一个匹配操作</p><p>IK 提供了两个分词算法: ik_smart 和 ik_max_word ,其中 ik_smart 为最少切分,ik_max_word 为最细粒度划分! <img src="/audition/assets/img/1646090841265.c531a5bb.png" alt="picture 3"></p><h2 id="_1-6-rest-风格说明" tabindex="-1"><a class="header-anchor" href="#_1-6-rest-风格说明" aria-hidden="true">#</a> 1.6. Rest 风格说明</h2><table><thead><tr><th>method</th><th>url地址</th><th>描述</th></tr></thead><tbody><tr><td>PUT(创建,修改)</td><td>localhost:9200/索引名称/类型名称/文档id</td><td>创建文档(指定文档id)</td></tr><tr><td>POST(创建)</td><td>localhost:9200/索引名称/类型名称</td><td>创建文档(随机文档id)</td></tr><tr><td>POST(修改)</td><td>localhost:9200/索引名称/类型名称/文档id/_update</td><td>修改文档</td></tr><tr><td>DELETE(删除)</td><td>localhost:9200/索引名称/类型名称/文档id</td><td>删除文档</td></tr><tr><td>GET(查询)</td><td>localhost:9200/索引名称/类型名称/文档id</td><td>查询文档通过文档ID</td></tr><tr><td>POST(查询)</td><td>localhost:9200/索引名称/类型名称/文档id/_search</td><td>查询所有数据</td></tr></tbody></table><h2 id="_1-7-springboot-使用" tabindex="-1"><a class="header-anchor" href="#_1-7-springboot-使用" aria-hidden="true">#</a> 1.7. springboot 使用</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticSearchConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册 rest高级客户端 </span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">restHighLevelClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
                <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">9200</span><span class="token punctuation">,</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>


<span class="token comment">// 索引的操作</span>
<span class="token comment">// 1,索引的创建</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCreateIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CreateIndexResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 查看是否创建成功</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 查看返回对象</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2,索引的获取,并判断其是否存在</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testIndexIsExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 索引是否存在</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 3,索引的删除</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AcknowledgedResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isAcknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 是否删除成功</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 文档的操作</span>

<span class="token comment">// 1,文档的添加</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAddDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个User对象</span>
    <span class="token class-name">User</span> liuyou <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建请求</span>
    <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 制定规则 PUT /liuyou_index/_doc/1</span>
    request<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置文档ID</span>
    request<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">TimeValue</span><span class="token punctuation">.</span><span class="token function">timeValueMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// request.timeout(&quot;1s&quot;)</span>
    <span class="token comment">// 将我们的数据放入请求中</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>liuyou<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 客户端发送请求,获取响应的结果</span>
    <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取建立索引的状态信息 CREATED</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 查看返回内容 IndexResponse[index=liuyou_index,type=_doc,id=1,version=1,result=created,seqNo=0,primaryTerm=1,shards={&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0}]</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2,文档信息的获取</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GetResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 打印文档内容</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回的全部内容和命令是一样的</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 3,文档的获取,并判断其是否存在</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDocumentIsExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 不获取返回的 _source的上下文了</span>
    request<span class="token punctuation">.</span><span class="token function">fetchSourceContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FetchSourceContext</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">storedFields</span><span class="token punctuation">(</span><span class="token string">&quot;_none_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 4,文档的更新</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;lmk&quot;</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UpdateResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// OK</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 5,文档的删除</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDeleteDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou_index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token string">&quot;1s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DeleteResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// OK</span>
<span class="token punctuation">}</span>
<span class="token comment">// 6,文档的查询</span>
<span class="token comment">// 查询</span>
<span class="token comment">// SearchRequest 搜索请求</span>
<span class="token comment">// SearchSourceBuilder 条件构造</span>
<span class="token comment">// HighlightBuilder 高亮</span>
<span class="token comment">// TermQueryBuilder 精确查询</span>
<span class="token comment">// MatchAllQueryBuilder</span>
<span class="token comment">// xxxQueryBuilder ...</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建查询请求对象</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.构建搜索条件</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// (1)查询条件 使用QueryBuilders工具类创建</span>
    <span class="token comment">// 精确查询</span>
    <span class="token class-name">TermQueryBuilder</span> termQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;liuyou&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        // 匹配查询</span>
    <span class="token comment">//        MatchAllQueryBuilder matchAllQueryBuilder = QueryBuilders.matchAllQuery();</span>
    <span class="token comment">// (2)其他&lt;可有可无&gt;:(可以参考 SearchSourceBuilder 的字段部分)</span>
    <span class="token comment">// 设置高亮</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        // 分页</span>
    <span class="token comment">//        searchSourceBuilder.from();</span>
    <span class="token comment">//        searchSourceBuilder.size();</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeValue</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// (3)条件投入</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>termQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.添加条件到请求</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.客户端查询请求</span>
    <span class="token class-name">SearchResponse</span> search <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.查看返回结果</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=======================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> documentFields <span class="token operator">:</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>documentFields<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 前面的操作都无法批量添加数据</span>
<span class="token comment">// 上面的这些api无法批量增加数据(只会保留最后一个source)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;bulk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 没有id会自动生成一个随机ID</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liu&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;min&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;kai&quot;</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IndexResponse</span> index <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>index<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// created</span>
<span class="token punctuation">}</span>
<span class="token comment">// 7,批量添加数据</span>
<span class="token comment">// 特殊的,真的项目一般会 批量插入数据</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bulkRequest<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token string">&quot;10s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-1&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-2&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-3&quot;</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-4&quot;</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-5&quot;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;liuyou-6&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 批量请求处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> users<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
                <span class="token comment">// 这里是数据信息</span>
                <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;bulk&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 没有设置id 会自定生成一个随机id</span>
                        <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">BulkResponse</span> bulk <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bulk<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ok</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br></div></div><h2 id="_1-8-为什么要使用elasticsearch" tabindex="-1"><a class="header-anchor" href="#_1-8-为什么要使用elasticsearch" aria-hidden="true">#</a> 1.8. 为什么要使用Elasticsearch?</h2><p>因为在我们商城中的数据,将来会非常多,所以采用以往的模糊查询,模糊查询前置配置,会放弃索引,导致商品查询是全表扫描,在百万级别的数据库中,效率非常低下,而我们使用ES做一个全文索引,我们将经常查询的商品的某些字段,比如说商品名,描述,价格还有id这些字段我们放入我们索引库里,可以提高查询速度.</p><h2 id="_1-9-es-的写入流程" tabindex="-1"><a class="header-anchor" href="#_1-9-es-的写入流程" aria-hidden="true">#</a> 1.9. ES 的写入流程</h2><p><img src="/audition/assets/img/1646450239747.f34594c0.png" alt="picture 2"></p><ol><li>客户端选择一个 node 发送请求过去,这个 node 就是 coordinating node (协调节点)</li><li>coordinating node 对 document 进行路由,将请求转发给对应的 node(有 primary shard)</li><li>实际的 node 上的 primary shard 处理请求,然后将数据同步到 replica node</li><li>coordinating node 等到 primary node 和所有 replica node 都执行成功之后,就返回响应结果给客户端.</li></ol><h2 id="_1-10-es-的更新和删除流程" tabindex="-1"><a class="header-anchor" href="#_1-10-es-的更新和删除流程" aria-hidden="true">#</a> 1.10. ES 的更新和删除流程</h2><p>删除和更新都是写操作,但是由于 Elasticsearch 中的文档是不可变的,因此不能被删除或者改动以展示其变更;所以 ES 利用 .del 文件 标记文档是否被删除,磁盘上的每个段都有一个相应的.del 文件</p><ol><li>如果是删除操作,文档其实并没有真的被删除,而是在 .del 文件中被标记为 deleted 状态.该文档依然能匹配查询,但是会在结果中被过滤掉.</li><li>如果是更新操作,就是将旧的 doc 标识为 deleted 状态,然后创建一个新的 doc.</li></ol><h2 id="_1-11-es-的搜索流程" tabindex="-1"><a class="header-anchor" href="#_1-11-es-的搜索流程" aria-hidden="true">#</a> 1.11. ES 的搜索流程</h2><p>搜索被执行成一个两阶段过程,即 Query Then Fetch:</p><h3 id="_1-11-1-query-阶段" tabindex="-1"><a class="header-anchor" href="#_1-11-1-query-阶段" aria-hidden="true">#</a> 1.11.1. Query 阶段</h3><p>客户端发送请求到 coordinate node,协调节点将搜索请求广播到所有的 primary shard 或 replica shard.每个分片在本地执行搜索并构建一个匹配文档的大小为 from + size 的优先队列. 每个分片返回各自优先队列中 所有文档的 ID 和排序值 给协调节点,由协调节点及逆行数据的合并,排序,分页等操作,产出最终结果.</p><h3 id="_1-11-2-fetch-阶段" tabindex="-1"><a class="header-anchor" href="#_1-11-2-fetch-阶段" aria-hidden="true">#</a> 1.11.2. Fetch 阶段</h3><p>协调节点根据 doc id 去各个节点上查询实际的 document 数据,由协调节点返回结果给客户端.</p><h2 id="_1-12-在并发情况下-elasticsearch如果保证读写一致" tabindex="-1"><a class="header-anchor" href="#_1-12-在并发情况下-elasticsearch如果保证读写一致" aria-hidden="true">#</a> 1.12. 在并发情况下,Elasticsearch如果保证读写一致?</h2><h3 id="_1-12-1-对于更新操作" tabindex="-1"><a class="header-anchor" href="#_1-12-1-对于更新操作" aria-hidden="true">#</a> 1.12.1. 对于更新操作</h3><p>可以通过版本号使用乐观并发控制,以确保新版本不会被旧版本覆盖</p><p>每个文档都有一个_version 版本号,这个版本号在文档被改变时加一.Elasticsearch 使用这个_version 保证所有修改都被正确排序.当一个旧版本出现在新版本之后,它会被简单的忽略.</p><p>利用_version 的这一优点确保数据不会因为修改冲突而丢失.比如指定文档的 version 来做更改.如果那个版本号不是现在的,我们的请求就失败了.</p><h3 id="_1-12-2-对于写操作" tabindex="-1"><a class="header-anchor" href="#_1-12-2-对于写操作" aria-hidden="true">#</a> 1.12.2. 对于写操作</h3><p>一致性级别支持 quorum/one/all,默认为 quorum,即只有当大多数分片可用时才允许写操作.但即使大多数可用,也可能存在因为网络等原因导致写入副本失败,这样该副本被认为故障,分片将会在一个不同的节点上重建.</p><ol><li>one:要求我们这个写操作,只要有一个 primary shard 是 active 活跃可用的,就可以执行</li><li>all:要求我们这个写操作,必须所有的 primary shard 和 replica shard 都是活跃的,才可以执行这个写操作</li><li>quorum:默认的值,要求所有的 shard 中,必须是大部分的 shard 都是活跃的,可用的,才可以执行这个写操作</li></ol><h3 id="_1-12-3-对于读操作" tabindex="-1"><a class="header-anchor" href="#_1-12-3-对于读操作" aria-hidden="true">#</a> 1.12.3. 对于读操作</h3><p>可以设置 replication 为 sync (默认),这使得操作在主分片和副本分片都完成后才会返回;如果设置 replication 为 async 时,也可以通过设置搜索请求参数 _preference 为 primary 来查询主分片,确保文档是最新版本.</p><h2 id="_1-13-es-的性能优化-深度分页与滚动搜索-scroll" tabindex="-1"><a class="header-anchor" href="#_1-13-es-的性能优化-深度分页与滚动搜索-scroll" aria-hidden="true">#</a> 1.13. ES 的性能优化, 深度分页与滚动搜索 scroll</h2><h3 id="_1-13-1-深度分页" tabindex="-1"><a class="header-anchor" href="#_1-13-1-深度分页" aria-hidden="true">#</a> 1.13.1. 深度分页</h3><p>深度分页其实就是搜索的深浅度,比如第 1 页,第 2 页,第 10 页,第 20 页,是比较浅的;第 10000 页,第 20000 页就是很深了.搜索得太深,就会造成性能问题,会耗费内存和占用 cpu.而且 es 为了性能,他不支持超过一万条数据以上的分页查询.那么如何解决深度分页带来的问题,我们应该避免深度分页操作(限制分页页数),比如最多只能提供 100 页的展示,从第 101 页开始就没了,毕竟用户也不会搜的那么深.</p><h3 id="_1-13-2-滚动搜索" tabindex="-1"><a class="header-anchor" href="#_1-13-2-滚动搜索" aria-hidden="true">#</a> 1.13.2. 滚动搜索</h3><p>一次性查询 1 万 + 数据,往往会造成性能影响,因为数据量太多了.这个时候可以使用滚动搜索,也就是 scroll. 滚动搜索可以先查询出一些数据,然后再紧接着依次往下查询.在第一次查询的时候会有一个滚动 id,相当于一个锚标记 ,随后再次滚动搜索会需要上一次搜索滚动 id,根据这个进行下一次的搜索请求.每次搜索都是基于一个历史的数据快照,查询数据的期间,如果有数据变更,那么和搜索是没有关系的.</p><h2 id="_1-14-es的数据类型" tabindex="-1"><a class="header-anchor" href="#_1-14-es的数据类型" aria-hidden="true">#</a> 1.14. es的数据类型</h2><h3 id="_1-14-1-常用的数据类型" tabindex="-1"><a class="header-anchor" href="#_1-14-1-常用的数据类型" aria-hidden="true">#</a> 1.14.1. 常用的数据类型</h3><ol><li>keyword 类型</li><li>text 类型 (支持分词)</li><li>数字类型</li><li>时间类型</li></ol><h3 id="_1-14-2-复杂的数据类型" tabindex="-1"><a class="header-anchor" href="#_1-14-2-复杂的数据类型" aria-hidden="true">#</a> 1.14.2. 复杂的数据类型</h3><ol><li>数组类型</li><li>对象类型</li><li>嵌套类型</li></ol><h2 id="_1-15-搜索的整体技术架构" tabindex="-1"><a class="header-anchor" href="#_1-15-搜索的整体技术架构" aria-hidden="true">#</a> 1.15. 搜索的整体技术架构</h2><p><img src="/audition/assets/img/1646451265736.35b40da6.png" alt="picture 3"></p><h2 id="_1-16-1设计阶段调优" tabindex="-1"><a class="header-anchor" href="#_1-16-1设计阶段调优" aria-hidden="true">#</a> 1.16. 1设计阶段调优</h2><ol><li>根据业务增量需求，采取基于日期模板创建索引，通过 roll over API 滚动索引；</li><li>使用别名进行索引管理；</li><li>每天凌晨定时对索引做 force_merge 操作，以释放空间；</li><li>采取冷热分离机制，热数据存储到 SSD，提高检索效率；冷数据定期进行 shrink 操作，以缩减存储；</li><li>采取 curator 进行索引的生命周期管理；</li><li>仅针对需要分词的字段，合理的设置分词器；</li><li>Mapping 阶段充分结合各个字段的属性，是否需要检索、是否需要存储等。</li></ol><h2 id="_1-17-写入调优" tabindex="-1"><a class="header-anchor" href="#_1-17-写入调优" aria-hidden="true">#</a> 1.17. 写入调优</h2><ol><li>写入前副本数设置为 0;</li><li>写入前关闭 refresh_interval 设置为 -1, 禁用刷新机制;</li><li>写入过程中:采取 bulk 批量写入;</li><li>写入后恢复副本数和刷新间隔;</li><li>尽量使用自动生成的 id.</li></ol><h2 id="_1-18-查询调优" tabindex="-1"><a class="header-anchor" href="#_1-18-查询调优" aria-hidden="true">#</a> 1.18. 查询调优</h2><ol><li>禁用 wildcard;</li><li>禁用批量 terms(成百上千的场景);</li><li>充分利用倒排索引机制,能 keyword 类型尽量 keyword;</li><li>数据量大时候,可以先基于时间敲定索引再检索;</li><li>设置合理的路由机制.</li></ol><h2 id="_1-19-elasticsearch-对于大数据量-上亿量级-的聚合如何实现" tabindex="-1"><a class="header-anchor" href="#_1-19-elasticsearch-对于大数据量-上亿量级-的聚合如何实现" aria-hidden="true">#</a> 1.19. Elasticsearch 对于大数据量（上亿量级）的聚合如何实现？</h2><p>Elasticsearch 提供的首个近似聚合是 cardinality 度量。它提供一个字段的基数，即该字段的 distinct 或者 unique 值的数目。它是基于 HLL 算法的。HLL 会先对我们的输入作哈希运算，然后根据哈希运算 的结果中的 bits 做概率估算从而得到基数。其特点是：可配置的精度，用来控制内存的使用（更精确 ＝ 更多内存）；小的数据集精度是非常高的；我们可以通过配置参数，来设置去重需要的固定内存使用量。无论数千还是数十亿的唯一值，内存使用量只与你配置的精确度相关。</p><h2 id="_1-20-es-在数据量很大的情况下-数十亿级别-如何提高查询效率" tabindex="-1"><a class="header-anchor" href="#_1-20-es-在数据量很大的情况下-数十亿级别-如何提高查询效率" aria-hidden="true">#</a> 1.20. ES 在数据量很大的情况下（数十亿级别）如何提高查询效率？</h2><p><img src="/audition/assets/img/1646452279264.5a619c3c.png" alt="picture 4"></p><p>es 的搜索引擎严重依赖于底层的 filesystem cache(文件系统缓存, 内存)，你如果给 filesystem cache 更多的内存，尽量让内存可以容纳所有的 idx segment file 索引数据文件，那么你搜索的时候就基本都是走内存的，性能会非常高。 你往 ES 里写的数据，实际上都写到磁盘文件里去了，查询的时候，操作系统会将磁盘文件里的数据自动缓存到 Filesystem Cache 里面去。你要让 es 性能要好，最佳的情况下，就是你的机器的内存，至少可以容纳你的总数据量的一半。 数据与热: 对于那些你觉得比较热的、经常会有人访问的数据，对热数据每隔一段时间，就提前访问一下，让数据进入 filesystem cache 里面去。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">4/8/2022, 6:44:26 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: shorestraydog@protonmail.com">shorestraydog</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/audition/database/redis.html" class="nav-link" aria-label="1. redis"><!--[--><!--]--> 1. redis <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/audition/assets/js/runtime~app.d53e597b.js" defer></script><script src="/audition/assets/js/812.cf73d600.js" defer></script><script src="/audition/assets/js/app.44937fea.js" defer></script>
  </body>
</html>
