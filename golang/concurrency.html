<!DOCTYPE html>
<html lang="en-EN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>1. concurrency | 努力！奋斗！</title><meta name="description" content="">
    <link rel="preload" href="/audition/assets/js/runtime~app.d53e597b.js" as="script"><link rel="preload" href="/audition/assets/css/styles.81f20975.css" as="style"><link rel="preload" href="/audition/assets/js/812.cf73d600.js" as="script"><link rel="preload" href="/audition/assets/js/app.44937fea.js" as="script">
    <link rel="stylesheet" href="/audition/assets/css/styles.81f20975.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/audition/" class=""><!----><span class="site-name can-hide">努力！奋斗！</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/audition/" class="nav-link" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/java/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/collection" class="nav-link" aria-label="collection"><!--[--><!--]--> collection <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingbasic" class="nav-link" aria-label="multithreadingbasic"><!--[--><!--]--> multithreadingbasic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingadvanced" class="nav-link" aria-label="multithreadingadvanced"><!--[--><!--]--> multithreadingadvanced <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/jvm" class="nav-link" aria-label="jvm"><!--[--><!--]--> jvm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/spring/springboot" class="nav-link" aria-label="springboot"><!--[--><!--]--> springboot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/spring/mybatis" class="nav-link" aria-label="mybatis"><!--[--><!--]--> mybatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/mq/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rabbitmq" class="nav-link" aria-label="rabbitmq"><!--[--><!--]--> rabbitmq <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/kafka" class="nav-link" aria-label="kafka"><!--[--><!--]--> kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rocketmq" class="nav-link" aria-label="rocketmq"><!--[--><!--]--> rocketmq <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/database/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/mysql" class="nav-link" aria-label="mysql"><!--[--><!--]--> mysql <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/redis" class="nav-link" aria-label="redis"><!--[--><!--]--> redis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/elasticsearch" class="nav-link" aria-label="elasticsearch"><!--[--><!--]--> elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/distributed/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/zookeeper" class="nav-link" aria-label="zookeeper"><!--[--><!--]--> zookeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/dubbo" class="nav-link" aria-label="dubbo"><!--[--><!--]--> dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/springcloud" class="nav-link" aria-label="springcloud"><!--[--><!--]--> springcloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/additional/network" class="nav-link" aria-label="network"><!--[--><!--]--> network <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/linux" class="nav-link" aria-label="linux"><!--[--><!--]--> linux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/designPattern" class="nav-link" aria-label="designPattern"><!--[--><!--]--> designPattern <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/golang/codingstandard" class="nav-link" aria-label="codingstandard"><!--[--><!--]--> codingstandard <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/concurrency" class="nav-link router-link-active" aria-label="concurrency"><!--[--><!--]--> concurrency <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/audition/interview/" class="nav-link" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/business/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/audition/" class="nav-link" aria-label="home"><!--[--><!--]--> home <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="java"><span class="title">java</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/java/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/collection" class="nav-link" aria-label="collection"><!--[--><!--]--> collection <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingbasic" class="nav-link" aria-label="multithreadingbasic"><!--[--><!--]--> multithreadingbasic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/multithreadingadvanced" class="nav-link" aria-label="multithreadingadvanced"><!--[--><!--]--> multithreadingadvanced <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/java/jvm" class="nav-link" aria-label="jvm"><!--[--><!--]--> jvm <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="spring"><span class="title">spring</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/spring/springboot" class="nav-link" aria-label="springboot"><!--[--><!--]--> springboot <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/spring/mybatis" class="nav-link" aria-label="mybatis"><!--[--><!--]--> mybatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="mq"><span class="title">mq</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/mq/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rabbitmq" class="nav-link" aria-label="rabbitmq"><!--[--><!--]--> rabbitmq <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/kafka" class="nav-link" aria-label="kafka"><!--[--><!--]--> kafka <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/mq/rocketmq" class="nav-link" aria-label="rocketmq"><!--[--><!--]--> rocketmq <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="database"><span class="title">database</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/database/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/mysql" class="nav-link" aria-label="mysql"><!--[--><!--]--> mysql <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/redis" class="nav-link" aria-label="redis"><!--[--><!--]--> redis <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/database/elasticsearch" class="nav-link" aria-label="elasticsearch"><!--[--><!--]--> elasticsearch <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="distributed"><span class="title">distributed</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/distributed/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/zookeeper" class="nav-link" aria-label="zookeeper"><!--[--><!--]--> zookeeper <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/dubbo" class="nav-link" aria-label="dubbo"><!--[--><!--]--> dubbo <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/distributed/springcloud" class="nav-link" aria-label="springcloud"><!--[--><!--]--> springcloud <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="additional"><span class="title">additional</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/additional/network" class="nav-link" aria-label="network"><!--[--><!--]--> network <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/linux" class="nav-link" aria-label="linux"><!--[--><!--]--> linux <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/additional/designPattern" class="nav-link" aria-label="designPattern"><!--[--><!--]--> designPattern <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/golang/codingstandard" class="nav-link" aria-label="codingstandard"><!--[--><!--]--> codingstandard <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/basic" class="nav-link" aria-label="basic"><!--[--><!--]--> basic <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/concurrency" class="nav-link router-link-active" aria-label="concurrency"><!--[--><!--]--> concurrency <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/audition/golang/distributed" class="nav-link" aria-label="distributed"><!--[--><!--]--> distributed <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/audition/interview/" class="nav-link" aria-label="interview"><!--[--><!--]--> interview <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="business"><span class="title">business</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/audition/business/summary" class="nav-link" aria-label="summary"><!--[--><!--]--> summary <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">golang</p><ul class=""><li><!--[--><a href="/audition/golang/codingstandard.html" class="nav-link sidebar-item" aria-label="1. Go 语言编码规范"><!--[--><!--]--> 1. Go 语言编码规范 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/audition/golang/basic.html" class="nav-link sidebar-item" aria-label="1. basic"><!--[--><!--]--> 1. basic <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="1. concurrency"><!--[--><!--]--> 1. concurrency <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-1-并发和并行的区别是什么" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.1. 并发和并行的区别是什么"><!--[--><!--]--> 1.1. 并发和并行的区别是什么 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-2-golang-如何安全读写共享变量" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.2. golang 如何安全读写共享变量"><!--[--><!--]--> 1.2. golang 如何安全读写共享变量 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-3-golang中常用的并发模型" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.3. golang中常用的并发模型"><!--[--><!--]--> 1.3. golang中常用的并发模型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-4-context-是什么" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.4. context 是什么"><!--[--><!--]--> 1.4. context 是什么 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-5-context-使用场景及注意事项" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.5. context 使用场景及注意事项"><!--[--><!--]--> 1.5. context 使用场景及注意事项 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-6-context-使用场景" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.6. context 使用场景"><!--[--><!--]--> 1.6. context 使用场景 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-7-协程和线程和进程的区别" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.7. 协程和线程和进程的区别"><!--[--><!--]--> 1.7. 协程和线程和进程的区别 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-8-什么是-gmp-调度过程是什么样的" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.8. 什么是 GMP? 调度过程是什么样的?"><!--[--><!--]--> 1.8. 什么是 GMP? 调度过程是什么样的? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-9-gmp-的数量问题" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.9. GMP 的数量问题?"><!--[--><!--]--> 1.9. GMP 的数量问题? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-10-通道-channel" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.10. 通道(channel)"><!--[--><!--]--> 1.10. 通道(channel) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-11-go-channel为什么是安全的" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.11. go channel为什么是安全的?"><!--[--><!--]--> 1.11. go channel为什么是安全的? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-12-对已经关闭的的-chan-进行读写-会怎么样-为什么" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.12. 对已经关闭的的 chan 进行读写,会怎么样?为什么?"><!--[--><!--]--> 1.12. 对已经关闭的的 chan 进行读写,会怎么样?为什么? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-13-等待组-waitgroup" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.13. 等待组 WaitGroup"><!--[--><!--]--> 1.13. 等待组 WaitGroup <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-14-sync-once-与-init-区别" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.14. sync.Once 与 init() 区别"><!--[--><!--]--> 1.14. sync.Once 与 init() 区别 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-15-golang并发-选channel还是选锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.15. golang并发,选channel还是选锁"><!--[--><!--]--> 1.15. golang并发,选channel还是选锁 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-16-golang-的锁机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.16. golang 的锁机制"><!--[--><!--]--> 1.16. golang 的锁机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-17-乐观锁和悲观锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.17. 乐观锁和悲观锁"><!--[--><!--]--> 1.17. 乐观锁和悲观锁 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-18-在go函数中为什么会发生内存泄露-goroutine泄露" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.18. 在go函数中为什么会发生内存泄露(goroutine泄露)"><!--[--><!--]--> 1.18. 在go函数中为什么会发生内存泄露(goroutine泄露) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-19-select-可以用于什么" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.19. select 可以用于什么?"><!--[--><!--]--> 1.19. select 可以用于什么? <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-20-goroutine的优雅退出" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.20. goroutine的优雅退出"><!--[--><!--]--> 1.20. goroutine的优雅退出 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-21-如何让所有子协程执行完后再执行主协程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.21. 如何让所有子协程执行完后再执行主协程"><!--[--><!--]--> 1.21. 如何让所有子协程执行完后再执行主协程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/audition/golang/concurrency.html#_1-22-知道哪些-sync-同步原语-各有什么作用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1.22. 知道哪些 sync 同步原语?各有什么作用?"><!--[--><!--]--> 1.22. 知道哪些 sync 同步原语?各有什么作用? <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/audition/golang/distributed.html" class="nav-link sidebar-item" aria-label="1. distributed"><!--[--><!--]--> 1. distributed <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_1-concurrency" tabindex="-1"><a class="header-anchor" href="#_1-concurrency" aria-hidden="true">#</a> 1. concurrency</h1><p>Do not communicate by sharing memory. Instead, share memory by communicating.</p><h2 id="_1-1-并发和并行的区别是什么" tabindex="-1"><a class="header-anchor" href="#_1-1-并发和并行的区别是什么" aria-hidden="true">#</a> 1.1. 并发和并行的区别是什么</h2><ol><li>并发: 同一时间段, 多个任务都在执行</li><li>并行: 单位时间内, 多个任务同时执行.</li></ol><h2 id="_1-2-golang-如何安全读写共享变量" tabindex="-1"><a class="header-anchor" href="#_1-2-golang-如何安全读写共享变量" aria-hidden="true">#</a> 1.2. golang 如何安全读写共享变量</h2><h3 id="_1-2-1-mutext加锁安全读写共享变量" tabindex="-1"><a class="header-anchor" href="#_1-2-1-mutext加锁安全读写共享变量" aria-hidden="true">#</a> 1.2.1. mutext加锁安全读写共享变量</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//  var mutex sync.Mutex</span>
 count <span class="token operator">:=</span> <span class="token number">0</span>

 <span class="token keyword">for</span> r <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> r<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//    mutex.Lock()</span>
<span class="token comment">//    defer mutex.Unlock()</span>
   count <span class="token operator">+=</span> <span class="token number">1</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 8</span>
<span class="token comment">// 7</span>
<span class="token comment">// 9</span>
<span class="token comment">// 1</span>
<span class="token comment">// 3</span>
<span class="token comment">// 4</span>
<span class="token comment">// 5</span>
<span class="token comment">// 6</span>
<span class="token comment">// 10</span>
<span class="token comment">// 2</span>

<span class="token comment">// 加锁后值依次递增输出</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_1-2-2-goroutine-安全读写共享变量" tabindex="-1"><a class="header-anchor" href="#_1-2-2-goroutine-安全读写共享变量" aria-hidden="true">#</a> 1.2.2. goroutine 安全读写共享变量</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> deposits <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// send amout to deposit</span>
<span class="token keyword">var</span> balances <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// receive balance</span>
<span class="token comment">// Deposit 存款</span>
<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> deposits <span class="token operator">&lt;-</span> amount <span class="token punctuation">}</span>

<span class="token comment">// Balance 余额</span>
<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&lt;-</span>balances <span class="token punctuation">}</span>

<span class="token comment">// 出纳员</span>
<span class="token keyword">func</span> <span class="token function">teller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> balance <span class="token builtin">int</span> <span class="token comment">// balance is confined to teller goroutine</span>
 <span class="token keyword">for</span> <span class="token punctuation">{</span>
  <span class="token keyword">select</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> amount <span class="token operator">:=</span> <span class="token operator">&lt;-</span>deposits<span class="token punctuation">:</span>
   balance <span class="token operator">+=</span> amount
  <span class="token keyword">case</span> balances <span class="token operator">&lt;-</span> balance<span class="token punctuation">:</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">go</span> <span class="token function">teller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// start the monitor goroutine</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// prints 10</span>
 <span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// prints 30</span>
<span class="token punctuation">}</span>
<span class="token comment">// 通过 select 语句来实现的避免多个 goroutine 同时访问共享变量 balance</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="_1-3-golang中常用的并发模型" tabindex="-1"><a class="header-anchor" href="#_1-3-golang中常用的并发模型" aria-hidden="true">#</a> 1.3. golang中常用的并发模型</h2><h3 id="_1-3-1-通过channel-同步通道实现并发控制" tabindex="-1"><a class="header-anchor" href="#_1-3-1-通过channel-同步通道实现并发控制" aria-hidden="true">#</a> 1.3.1. 通过channel 同步通道实现并发控制</h3><p>无缓冲通道(同步通道)指的是通道的大小为0,它要求发送 goroutine 和接收 goroutine 同时准备好,才可以完成发送和接收操作.如果没有同时准备好的话,先执行的操作就会阻塞等待,直到另一个相对应的操作准备好为止.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start working&quot;</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
        ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;-</span>ch
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// start working</span>
<span class="token comment">// finished</span>
<span class="token comment">// 当主 goroutine 运行到 &lt;-ch 接受 channel 的值的时候,如果该 channel 中没有数据,就会一直阻塞等待,直到有值. 这样就可以简单实现并发控制</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_1-3-2-通过sync包中的waitgroup实现并发控制" tabindex="-1"><a class="header-anchor" href="#_1-3-2-通过sync包中的waitgroup实现并发控制" aria-hidden="true">#</a> 1.3.2. 通过sync包中的WaitGroup实现并发控制</h3><p>goroutine是异步执行的,为了防止在结束main函数的时候结束掉goroutine,所以需要同步等待,WaitGroup 主要用于同步多个协程间的状态，例如等待所有协程都执行完</p><h4 id="_1-3-2-1-在waitgroup里主要有三个方法" tabindex="-1"><a class="header-anchor" href="#_1-3-2-1-在waitgroup里主要有三个方法" aria-hidden="true">#</a> 1.3.2.1. 在WaitGroup里主要有三个方法</h4><p>Add, 可以添加goroutine的数量. Done, 相当于Add(-1). Wait, 执行后会堵塞主线程,直到WaitGroup 里的值减至0.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
 wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
 <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
   wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_1-3-3-上下文context实现并发控制" tabindex="-1"><a class="header-anchor" href="#_1-3-3-上下文context实现并发控制" aria-hidden="true">#</a> 1.3.3. 上下文Context实现并发控制</h3><p>context 包主要是用来处理多个 goroutine 之间共享数据,及多个 goroutine 的管理.</p><h2 id="_1-4-context-是什么" tabindex="-1"><a class="header-anchor" href="#_1-4-context-是什么" aria-hidden="true">#</a> 1.4. context 是什么</h2><p>context 主要用来在 goroutine 之间传递上下文信息, 用于控制goroutine的生命周期, 也常用于并发控制和超时控制</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{</span>  
    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        
    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> 
    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// Deadline会返回一个超时时间,routine获得了超时时间后,可以对某些io操作设定超时时间.</span>
<span class="token comment">// Done会返回一个channel,当该context被取消的时候,该channel会被关闭,同时对应的使用该context的routine也应该结束并返回.</span>
<span class="token comment">// Value可以让routine共享一些数据,当然获得数据是协程安全的.</span>
<span class="token comment">// Context中的方法是协程安全的,这也就代表了在父routine中创建的context,可以传递给任意数量的routine并让他们同时访问.</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_1-5-context-使用场景及注意事项" tabindex="-1"><a class="header-anchor" href="#_1-5-context-使用场景及注意事项" aria-hidden="true">#</a> 1.5. context 使用场景及注意事项</h2><p>context 用于控制 goroutine 的生命周期.当一个计算任务被 goroutine 承接了之后,由于某种原因(超时,或者强制退出)我们希望中止这个 goroutine 的计算任务,那么就用得到这个 Context 了.</p><p>context 有 cancelCtx, timerCtx, valueCtx. 它们分别是用来通知取消, 通知超时, 存储 key-value 值.</p><p><img src="/audition/assets/img/1648438385912.3f386efd.png" alt="picture 1"></p><h3 id="_1-5-1-context-的-注意事项如下" tabindex="-1"><a class="header-anchor" href="#_1-5-1-context-的-注意事项如下" aria-hidden="true">#</a> 1.5.1. context 的 注意事项如下</h3><p>context 的 Done() 方法往往需要配合 select {} 使用,以监听退出.尽量通过函数参数来暴露 context,不要在自定义结构体里包含它. WithValue 类型的 context 应该尽量存储一些全局的 data,而不要存储一些可有可无的局部 data. context 是并发安全的.一旦context 执行取消动作,所有派生的 context 都会触发取消.</p><h2 id="_1-6-context-使用场景" tabindex="-1"><a class="header-anchor" href="#_1-6-context-使用场景" aria-hidden="true">#</a> 1.6. context 使用场景</h2><h3 id="_1-6-1-rpc调用" tabindex="-1"><a class="header-anchor" href="#_1-6-1-rpc调用" aria-hidden="true">#</a> 1.6.1. RPC调用</h3><p>在主goroutine上有4个RPC,RPC2/3/4是并行请求的,我们这里希望在RPC2请求失败之后,直接返回错误,并且让RPC3/4停止继续计算.这个时候,就使用的到Context.使用了waitGroup来保证main函数在所有RPC调用完成之后才退出.当主goroutine想要告诉所有goroutine要结束的时候,通过cancel函数把结束的信息告诉给所有的goroutine.所有的goroutine都需要内置处理这个听声器结束信号的逻辑(ctx-&gt;Done())</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>
    <span class="token string">&quot;sync&quot;</span>
    <span class="token string">&quot;github.com/pkg/errors&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Rpc</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
    err<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 进行RPC调用,并且返回是否成功,成功通过result传递成功信息,错误通过error传递错误信息</span>
        isSuccess<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">if</span> isSuccess <span class="token punctuation">{</span>
            result <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            err <span class="token operator">&lt;</span> <span class="token operator">-</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;some error happen&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">// 其他RPC调用调用失败</span>
            <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> e<span class="token punctuation">:</span>
            <span class="token operator">=</span> <span class="token operator">&lt;</span> <span class="token operator">-</span>err<span class="token punctuation">:</span>
                <span class="token comment">// 本RPC调用失败,返回错误信息</span>
                <span class="token keyword">return</span> e
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>result<span class="token punctuation">:</span>
            <span class="token comment">// 本RPC调用成功,不返回错误信息</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> cancel<span class="token punctuation">:</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// RPC1调用</span>
    err<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">Rpc</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;http://rpc_1_url&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    wg<span class="token punctuation">:</span> <span class="token operator">=</span> sync<span class="token punctuation">.</span>WaitGroup <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// RPC2调用</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        err<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">Rpc</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;http://rpc_2_url&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// RPC3调用</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        err<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">Rpc</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;http://rpc_3_url&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// RPC4调用</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        err<span class="token punctuation">:</span> <span class="token operator">=</span> <span class="token function">Rpc</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;http://rpc_4_url&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h3 id="_1-6-2-超时请求-context-withtimeout" tabindex="-1"><a class="header-anchor" href="#_1-6-2-超时请求-context-withtimeout" aria-hidden="true">#</a> 1.6.2. 超时请求 (context.WithTimeout)</h3><p>发送RPC请求的时候,都会对这个请求进行一个超时的限制, 超时会自动断开.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;overslept&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// prints &quot;context deadline exceeded&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 客户端 http 请求</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 uri <span class="token operator">:=</span> <span class="token string">&quot;https://httpbin.org/delay/3&quot;</span>
 req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
 <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;http.NewRequest() failed with &#39;%s&#39;\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>

 ctx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span>
 req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

 resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
 <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;http.DefaultClient.Do() failed with:\n&#39;%s&#39;\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_1-6-3-http服务器的request互相传递数据" tabindex="-1"><a class="header-anchor" href="#_1-6-3-http服务器的request互相传递数据" aria-hidden="true">#</a> 1.6.3. HTTP服务器的request互相传递数据</h3><p>valueCtx最经常使用的场景就是在一个http服务器中,在request中传递一个特定值,比如有一个中间件,做权限验证,然后把验证后的用户名存放在request中.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">type</span> FooKey <span class="token builtin">string</span>

<span class="token keyword">var</span> UserName <span class="token operator">=</span> <span class="token function">FooKey</span><span class="token punctuation">(</span><span class="token string">&quot;user-name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> UserId <span class="token operator">=</span> <span class="token function">FooKey</span><span class="token punctuation">(</span><span class="token string">&quot;user-id&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UserId<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
  ctx2 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> UserName<span class="token punctuation">,</span> <span class="token string">&quot;yejianfeng&quot;</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx2<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetUserName</span><span class="token punctuation">(</span>context context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> ret<span class="token punctuation">,</span> ok <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>UserName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
  <span class="token keyword">return</span> ret
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetUserId</span><span class="token punctuation">(</span>context context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> ret<span class="token punctuation">,</span> ok <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>UserId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
  <span class="token keyword">return</span> ret
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;welcome: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token function">GetUserId</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token function">GetUserName</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token function">foo</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">)</span>
 http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h2 id="_1-7-协程和线程和进程的区别" tabindex="-1"><a class="header-anchor" href="#_1-7-协程和线程和进程的区别" aria-hidden="true">#</a> 1.7. 协程和线程和进程的区别</h2><ol><li>进程是CPU资源分配的基本单位,进程拥有自己的资源空间,一个进程包含若干个线程</li><li>线程是独立运行和独立调度的基本单位, 线程与CPU资源分配无关,多个线程共享同一进程内的资源.线程的调度与切换比进程快很多.</li><li>协程是一种用户态的轻量级线程,协程拥有自己的寄存器上下文和栈.</li></ol><h2 id="_1-8-什么是-gmp-调度过程是什么样的" tabindex="-1"><a class="header-anchor" href="#_1-8-什么是-gmp-调度过程是什么样的" aria-hidden="true">#</a> 1.8. 什么是 GMP? 调度过程是什么样的?</h2><p>go 语言天然支持高并发,可以在一个进程中启动成千上万个协程.</p><h3 id="_1-8-1-go-语言的并发模型-csp" tabindex="-1"><a class="header-anchor" href="#_1-8-1-go-语言的并发模型-csp" aria-hidden="true">#</a> 1.8.1. go 语言的并发模型 CSP</h3><p>CSP(通信顺序过程 Communicating Sequential Processes),是基于通道传递消息的理论,以通信的方式来共享内存, 它的核心观念是将两个并发执行的实体通过通道 channel 连接起来,所有的消息都通过 channel 传输.</p><h3 id="_1-8-2-go-语言对-csp-并发模型的实现-gpm-调度模型" tabindex="-1"><a class="header-anchor" href="#_1-8-2-go-语言对-csp-并发模型的实现-gpm-调度模型" aria-hidden="true">#</a> 1.8.2. go 语言对 CSP 并发模型的实现: GPM 调度模型</h3><p>GPM 代表了三个角色,分别是 goroutine,Processor,Machine(在golang 中等同于系统线程.). <img src="/audition/assets/img/1647609486264.7fd40f2d.png" alt="picture 1"></p><ol><li>G (协程:goroutine): go 协程,每个 go 关键字都会创建一个协程. <code>go func() {}()</code></li><li>M(thread):内核级线程,所有的 G 都要放在 M 上才能运行.</li><li>P (processor): 逻辑处理器,它的主要用途就是用来执行goroutine的,所以它也维护了一个goroutine队列,里面存储了所有需要它来执行的goroutine.</li></ol><h3 id="_1-8-3-go-调度器调度过程" tabindex="-1"><a class="header-anchor" href="#_1-8-3-go-调度器调度过程" aria-hidden="true">#</a> 1.8.3. go 调度器调度过程</h3><p>线程是运行 Goroutine 的实体，调度器的功能是把可运行的 Goroutine 分配到工作线程上。Goroutine 调度器和 OS 调度器是通过 M 结合起来的，每个 M 都代表了 1 个内核线程，OS 调度器负责把内核线程分配到 CPU 的核上执行。</p><p>新创建的goroutine会先存放在Global全局队列中,等待go调度器进行调度,随后goroutine被分配给其中的一个逻辑处理器P,并放到这个逻辑处理器对应的Local本地运行队列中,最终等待被逻辑处理器P执行即可.</p><p>在M与P绑定后,M会不断从P的Local队列中无锁地取出G,并切换到G的堆栈执行,当P的Local队列中没有G时,再从Global队列中获取一个G,当Global队列中也没有待运行的G时,则尝试从其它的P窃取部分G来执行相当于P之间的负载均衡.</p><h2 id="_1-9-gmp-的数量问题" tabindex="-1"><a class="header-anchor" href="#_1-9-gmp-的数量问题" aria-hidden="true">#</a> 1.9. GMP 的数量问题?</h2><h3 id="_1-9-1-p-的数量问题" tabindex="-1"><a class="header-anchor" href="#_1-9-1-p-的数量问题" aria-hidden="true">#</a> 1.9.1. P 的数量问题</h3><p>默认是 CPU 核心数,由启动时环境变量 goMAXPROCS 或者是由runtime.goMAXPROCS()决定</p><h3 id="_1-9-2-m-的数量问题" tabindex="-1"><a class="header-anchor" href="#_1-9-2-m-的数量问题" aria-hidden="true">#</a> 1.9.2. M 的数量问题</h3><ol><li>go 语⾔本身是限定 M 的最⼤量是 10000</li><li>runtime/debug 包中的 SetMaxThreads 函数来设置, <code>debug.SetMaxThreads()</code> 方法可以让我们修改最大线程数值.</li><li>有⼀个 M 阻塞,会创建⼀个新的 M</li><li>如果有 M 空闲,那么就会回收或者等待</li></ol><h3 id="_1-9-3-g-的数量问题" tabindex="-1"><a class="header-anchor" href="#_1-9-3-g-的数量问题" aria-hidden="true">#</a> 1.9.3. G 的数量问题</h3><h4 id="_1-9-3-1-怎么查看goroutine的数量" tabindex="-1"><a class="header-anchor" href="#_1-9-3-1-怎么查看goroutine的数量" aria-hidden="true">#</a> 1.9.3.1. 怎么查看goroutine的数量</h4><p>Numgoroutine可以查看goroutine的数量.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Numgoroutine返回当前存在的goroutine数量.</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//goMAXPROCS设置可以执行的cpu的最大数量</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_1-9-3-2-怎么限制goroutine的数量" tabindex="-1"><a class="header-anchor" href="#_1-9-3-2-怎么限制goroutine的数量" aria-hidden="true">#</a> 1.9.3.2. 怎么限制goroutine的数量</h4><p>可以使用 channel+WaitGroup 限制goroutine的数量</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> wg <span class="token operator">=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
 ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  ch <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;j %d \n&quot;</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
   <span class="token operator">&lt;-</span>ch
   wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_1-10-通道-channel" tabindex="-1"><a class="header-anchor" href="#_1-10-通道-channel" aria-hidden="true">#</a> 1.10. 通道(channel)</h2><p>channel 是 goroutine 之间的通信队列,可以使用 channel 在多个 goroutine 之间传递信息</p><p>go的设计思想是: 不要通过共享内存来通信(加锁), 而是通过通信来共享内存(channel), 设计channel的主要目的就是在多任务间传递数据的,本身就是安全的.</p><h3 id="_1-10-1-通道分为无缓存通道和有缓存通道" tabindex="-1"><a class="header-anchor" href="#_1-10-1-通道分为无缓存通道和有缓存通道" aria-hidden="true">#</a> 1.10.1. 通道分为无缓存通道和有缓存通道</h3><ol><li>无缓冲通道没有缓冲, 发送和接收需要同步.发送阻塞直到数据被接收,接收阻塞数据直到数据被读取.</li><li>有缓冲通道不要求发送和接收操作同步.当缓冲满时发送阻塞,当缓冲空时接收阻塞.</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 无缓冲通道</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
 <span class="token comment">// 接收者</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  v <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch <span class="token comment">// 这里阻塞</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;收到：&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token comment">// 发送者</span>
 ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;发送：&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 收到： 1</span>
<span class="token comment">// 发送： 1</span>

<span class="token comment">// 有缓冲通道</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
 <span class="token comment">// 发送者</span>
 ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;发送：&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

 <span class="token comment">// 接收者</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  v <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch <span class="token comment">// 这里阻塞</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;收到：&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 发送： 1</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_1-10-2-通道的关闭-close" tabindex="-1"><a class="header-anchor" href="#_1-10-2-通道的关闭-close" aria-hidden="true">#</a> 1.10.2. 通道的关闭, close()</h3><p>close函数关闭channel, 关闭后, 无法向channel再发送数据,可以继续从channel接收数据, 对于nil channel,无论收发都会被阻塞.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 chan1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
 chan1 <span class="token operator">&lt;-</span> <span class="token number">1</span>
 <span class="token function">close</span><span class="token punctuation">(</span>chan1<span class="token punctuation">)</span>
 <span class="token keyword">for</span> <span class="token punctuation">{</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>chan1
<span class="token comment">//  ok值表示是否读取成功, 如果 ok 的值为 false,则表示未读取到值, 通道已关闭.</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ok<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;channel closed!&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// true</span>
<span class="token comment">// false</span>
<span class="token comment">// channel closed!</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_1-10-3-超时处理" tabindex="-1"><a class="header-anchor" href="#_1-10-3-超时处理" aria-hidden="true">#</a> 1.10.3. 超时处理</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token comment">// 首先实现并执行一个匿名的超时等待函数</span>
timeout <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span> <span class="token comment">// 等待 1 秒</span>
    timeout <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 然后把 timeout 这个 channel 利用起来</span>
<span class="token keyword">select</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
    <span class="token comment">// 从 ch 中读取到数据</span>
<span class="token keyword">case</span> <span class="token operator">&lt;-</span> timeout<span class="token punctuation">:</span>
    <span class="token comment">// 一直没有从 ch 中读取到数据,但从 timeout 中读取到了数据</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Timeout occurred.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Timeout occurred.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="_1-11-go-channel为什么是安全的" tabindex="-1"><a class="header-anchor" href="#_1-11-go-channel为什么是安全的" aria-hidden="true">#</a> 1.11. go channel为什么是安全的?</h2><p>channel 发送和接收数据都是原子性的. channel内部维护了一个互斥锁,来保证线程安全</p><h2 id="_1-12-对已经关闭的的-chan-进行读写-会怎么样-为什么" tabindex="-1"><a class="header-anchor" href="#_1-12-对已经关闭的的-chan-进行读写-会怎么样-为什么" aria-hidden="true">#</a> 1.12. 对已经关闭的的 chan 进行读写,会怎么样?为什么?</h2><ol><li><p>读已经关闭的 chan, 如果 chan 关闭前,buffer 内有未读数据, 会读取 chan 内的值,且返回的第二个 bool 值为 true.</p></li><li><p>读已经关闭的 chan, 如果 chan 关闭前,buffer 内没有未读数据, 所有接收的值都会非阻塞直接成功,返回 channel 元素的零值,但是第二个 bool 值一直为 false.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    c <span class="token operator">&lt;-</span> <span class="token number">1</span>
    <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    num<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;第一次读取chan的协程,num=%v, ok=%v\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
    num1<span class="token punctuation">,</span> ok1 <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;第二次读取chan的协程,num=%v, ok=%v\n&quot;</span><span class="token punctuation">,</span> num1<span class="token punctuation">,</span> ok1<span class="token punctuation">)</span>
    num2<span class="token punctuation">,</span> ok2 <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;第三次读取chan的协程,num=%v, ok=%v\n&quot;</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> ok2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 第一次读取chan的协程,num=1, ok=true</span>
<span class="token comment">// 第二次读取chan的协程,num=0, ok=false</span>
<span class="token comment">// 第三次读取chan的协程,num=0, ok=false</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p>写已经关闭的 chan 会 panic</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    c <span class="token operator">&lt;-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h2 id="_1-13-等待组-waitgroup" tabindex="-1"><a class="header-anchor" href="#_1-13-等待组-waitgroup" aria-hidden="true">#</a> 1.13. 等待组 WaitGroup</h2><p>WaitGroup 主要用于同步多个协程间的状态, 例如等待所有协程都执行完.在 WaitGroup 对象实现中,内部有一个计数器,最初从 0 开始,它有三个方法:</p><ol><li>Add():计数器加一</li><li>Done():计数器减一</li><li>Wait():等待计数器清零. 执行Wait 方法的函数在等待组内部计数器不为 0 的时候会阻塞,一旦计数器为 0 了,程序就会继续往下执行.</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
    num <span class="token operator">:=</span> <span class="token number">10</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_1-14-sync-once-与-init-区别" tabindex="-1"><a class="header-anchor" href="#_1-14-sync-once-与-init-区别" aria-hidden="true">#</a> 1.14. sync.Once 与 init() 区别</h2><ol><li>sync.Once是在代码运行中需要的时候执行,且只执行一次.</li><li>init函数是在文件包首次被加载的时候执行,且只执行一次.</li><li>可以使用sync.Once实现单例模式</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
 <span class="token string">&quot;fmt&quot;</span>
 <span class="token string">&quot;sync&quot;</span>
 <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once
 <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// output:</span>
<span class="token comment">//  1</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="_1-15-golang并发-选channel还是选锁" tabindex="-1"><a class="header-anchor" href="#_1-15-golang并发-选channel还是选锁" aria-hidden="true">#</a> 1.15. golang并发,选channel还是选锁</h2><p>channel是设计在语言特性中的,并发问题优先使用通道, 如果通过通道解决不了的, 必须使用共享内存来实现并发的,才考虑锁机制</p><ol><li>channel的能力是让数据流动起来,擅长的是数据流动的场景 e.g. 传递数据的所有权,即把某个数据发送给其他协程</li><li>mutex的能力是数据保持不变,某段时间只给一个协程访问数据的权限, 擅长数据位置固定的场景 e.g. 缓存</li></ol><h2 id="_1-16-golang-的锁机制" tabindex="-1"><a class="header-anchor" href="#_1-16-golang-的锁机制" aria-hidden="true">#</a> 1.16. golang 的锁机制</h2><p>golang 中的有两种锁, 为互斥锁 sync.Mutex 和读写锁 sync.RWMutex. 两者都是悲观锁</p><h3 id="_1-16-1-互斥锁和读写锁区别" tabindex="-1"><a class="header-anchor" href="#_1-16-1-互斥锁和读写锁区别" aria-hidden="true">#</a> 1.16.1. 互斥锁和读写锁区别</h3><ol><li>互斥锁(Mutex): 用于保证在任何时刻, 都只能有一个线程访问该对象.当获取锁操作失败时,线程会进入等待,等待锁释放时被唤醒.</li><li>读写锁(RWMutex): 分为读锁和写锁.处于读操作时,可以允许多个线程同时获得读操作. 但是同一时刻只能有一个线程可以获得写锁.其它获取写锁失败的线程都会进入等待状态,直到写锁释放时被唤醒. 注意:写锁会阻塞其它读写锁.当有一个线程获得写锁时,读锁不能被其它线程获取; 写锁优先于读锁, 一旦有写锁, 则后续读锁必须等待,唤醒时优先考虑写锁.</li></ol><h3 id="_1-16-2-互斥锁" tabindex="-1"><a class="header-anchor" href="#_1-16-2-互斥锁" aria-hidden="true">#</a> 1.16.2. 互斥锁</h3><p>互斥锁是为了来保护一个资源不会因为并发操作而引起冲突导致数据异常. 加上 Mutex 互斥锁,要求同一时刻,仅能有一个协程对数据操作.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 没有互斥锁之前, 三个协程在执行时,先读取 count 再更新 count 的值,而这个过程并不具备原子性,</span>
<span class="token comment">// 所以导致了数据的不准确.解决这个问题的方法,就是给 add 这个函数加上 Mutex 互斥锁,要求同一时</span>
<span class="token comment">// 刻,仅能有一个协程能对 count 操作. </span>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>count <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">,</span> lock <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">*</span>count <span class="token operator">=</span> <span class="token operator">*</span>count <span class="token operator">+</span> <span class="token number">1</span>
        lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
    lock <span class="token operator">:=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
    count <span class="token operator">:=</span> <span class="token number">0</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">,</span> lock<span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">,</span> lock<span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">,</span> lock<span class="token punctuation">)</span>

    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;count 的值为:&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_1-16-2-1-注意事项" tabindex="-1"><a class="header-anchor" href="#_1-16-2-1-注意事项" aria-hidden="true">#</a> 1.16.2.1. 注意事项</h4><ol><li>同一协程里,不要在尚未解锁时再次加锁</li><li>同一协程里,不要对已解锁的锁再次解锁</li><li>加了锁后,别忘了解锁,必要时使用 defer 语句</li></ol><h3 id="_1-16-3-读写锁" tabindex="-1"><a class="header-anchor" href="#_1-16-3-读写锁" aria-hidden="true">#</a> 1.16.3. 读写锁</h3><p>读写锁是分别针对读操作和写操作进行锁定和解锁操作的互斥锁, 适用于读多于写少的场景</p><ol><li>读锁:调用 RLock 方法开启锁,调用 RUnlock 释放锁</li><li>写锁:调用 Lock 方法开启锁,调用 Unlock 释放锁(和 Mutex类似)</li></ol><h4 id="_1-16-3-1-基本原则-读写互斥" tabindex="-1"><a class="header-anchor" href="#_1-16-3-1-基本原则-读写互斥" aria-hidden="true">#</a> 1.16.3.1. 基本原则: 读写互斥</h4><ol><li>写锁定情况下，对读写锁进行读锁定或者写锁定，都将阻塞；</li><li>读锁定情况下，对读写锁进行写锁定，将阻塞；进行读锁定时不会阻塞, 支持多个并发读操作</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;sync&quot;</span>
    <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock <span class="token operator">:=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>RWMutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
    lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;第 %d 个协程准备开始... \n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;第 %d 个协程获得读锁, sleep 1s 后,释放锁\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
            lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;准备释放写锁,读锁不再阻塞&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 写锁一释放,读锁就自由了</span>
    lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 由于会等到读锁全部释放,才能获得写锁</span>
    <span class="token comment">// 因为这里一定会在上面 4 个协程全部完成才能往下走</span>
    lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;程序退出...&quot;</span><span class="token punctuation">)</span>
    lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 第 1 个协程准备开始...</span>
<span class="token comment">// 第 0 个协程准备开始...</span>
<span class="token comment">// 第 3 个协程准备开始...</span>
<span class="token comment">// 第 2 个协程准备开始...</span>
<span class="token comment">// 准备释放写锁,读锁不再阻塞</span>
<span class="token comment">// 第 2 个协程获得读锁, sleep 1s 后,释放锁</span>
<span class="token comment">// 第 3 个协程获得读锁, sleep 1s 后,释放锁</span>
<span class="token comment">// 第 1 个协程获得读锁, sleep 1s 后,释放锁</span>
<span class="token comment">// 第 0 个协程获得读锁, sleep 1s 后,释放锁</span>
<span class="token comment">// 程序退出...</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="_1-17-乐观锁和悲观锁" tabindex="-1"><a class="header-anchor" href="#_1-17-乐观锁和悲观锁" aria-hidden="true">#</a> 1.17. 乐观锁和悲观锁</h2><p>乐观锁和悲观锁是两种思想,用于解决并发场景下的数据竞争问题.</p><h3 id="_1-17-1-乐观锁" tabindex="-1"><a class="header-anchor" href="#_1-17-1-乐观锁" aria-hidden="true">#</a> 1.17.1. 乐观锁</h3><p>对于同一个数据的并发操作, 乐观锁认为自己在使用数据时不会有别的线程修改数据,所以不会添加锁,只是在更新数据的时候去判断之前有没有别的线程更新了这个数据. 乐观锁适用于读多写少的应用场景,这样可以提高吞吐量.</p><h3 id="_1-17-2-悲观锁" tabindex="-1"><a class="header-anchor" href="#_1-17-2-悲观锁" aria-hidden="true">#</a> 1.17.2. 悲观锁</h3><p>对于同一个数据的并发操作,悲观锁认为自己在使用数据的时候一定有别的线程来修改数据,因此在获取数据的时候会先加锁,确保数据不会被别的线程修改</p><h2 id="_1-18-在go函数中为什么会发生内存泄露-goroutine泄露" tabindex="-1"><a class="header-anchor" href="#_1-18-在go函数中为什么会发生内存泄露-goroutine泄露" aria-hidden="true">#</a> 1.18. 在go函数中为什么会发生内存泄露(goroutine泄露)</h2><p>go的并发是以goroutine和channel的形式实现的, goroutine需要维护执行用户代码的上下文信息.在运行过程中需要消耗一定的内存来保存这类信息. 因此,如果一个程序持续不断地产生新的 goroutine,且不结束已经创建的 goroutine,最终导致会内存耗尽,程序崩溃. 可以借助 pprof 排查</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_1-19-select-可以用于什么" tabindex="-1"><a class="header-anchor" href="#_1-19-select-可以用于什么" aria-hidden="true">#</a> 1.19. select 可以用于什么?</h2><p>select 用来监听和 channel 有关的 IO 操作，当 IO 操作发生时，触发相应的动作, select 只能应用于 channel 的操作, 可以用于监听 channel 的数据接收和发送.</p><p>如果 select 的多个分支都满足条件,则会随机的选取一个满足条件的分支执行. 否则执行default的逻辑.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 chan1 成功读到数据,则进行该 case 处理语句</span>
 <span class="token keyword">case</span> <span class="token operator">&lt;-</span> chan1<span class="token punctuation">:</span>
  <span class="token comment">// 如果成功向 chan2 写入数据,则进行该 case 处理语句</span>
 <span class="token keyword">case</span> chan2 <span class="token operator">&lt;-</span> <span class="token number">1</span><span class="token punctuation">:</span>
  <span class="token comment">// 如果上面都没有成功,则进入default处理流程</span>
 <span class="token keyword">default</span><span class="token punctuation">:</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_1-20-goroutine的优雅退出" tabindex="-1"><a class="header-anchor" href="#_1-20-goroutine的优雅退出" aria-hidden="true">#</a> 1.20. goroutine的优雅退出</h2><h3 id="_1-20-1-使用-for-range-退出" tabindex="-1"><a class="header-anchor" href="#_1-20-1-使用-for-range-退出" aria-hidden="true">#</a> 1.20.1. 使用 for-range 退出</h3><p>range能够感知channel的关闭,当channel被发送数据的协程关闭时,range就会结束,接着退出for循环.</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 inCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
 inCh <span class="token operator">&lt;-</span> <span class="token number">1</span>
 <span class="token function">close</span><span class="token punctuation">(</span>inCh<span class="token punctuation">)</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Using for-range to exit goroutine</span>
  <span class="token comment">// range has the ability to detect the close/end of a channel</span>
  <span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Process %d\n&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span>inCh<span class="token punctuation">)</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_1-20-2-使用select-case-ok退出" tabindex="-1"><a class="header-anchor" href="#_1-20-2-使用select-case-ok退出" aria-hidden="true">#</a> 1.20.2. 使用select case ,ok退出</h3><p>当读取数据的通道关闭时, 没有数据读取时程序会退出</p><h4 id="_1-20-2-1-某个通道关闭后-无需处理其他case-return退出协程" tabindex="-1"><a class="header-anchor" href="#_1-20-2-1-某个通道关闭后-无需处理其他case-return退出协程" aria-hidden="true">#</a> 1.20.2.1. 某个通道关闭后, 无需处理其他case, return退出协程</h4><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 in <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
 <span class="token function">close</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
 out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// in for-select using ok to exit goroutine</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> x<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
     fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Process exit %d\n&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
     <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>out<span class="token punctuation">:</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Working \n&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_1-20-2-2-某个通道关闭后-需要等待处理其他case-已关闭的通道设置为nil" tabindex="-1"><a class="header-anchor" href="#_1-20-2-2-某个通道关闭后-需要等待处理其他case-已关闭的通道设置为nil" aria-hidden="true">#</a> 1.20.2.2. 某个通道关闭后, 需要等待处理其他case, 已关闭的通道设置为nil</h4><p>select的特性: 不会在nil的通道上进行等待. 可以把只读通道设置为nil</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 in <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
 <span class="token function">close</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
 out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
 out <span class="token operator">&lt;-</span> <span class="token number">1</span>

 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// in for-select using ok to exit goroutine</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
     fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in channel closed&quot;</span><span class="token punctuation">)</span>
     in <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>out<span class="token punctuation">:</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Working&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// If both in channel are closed, goroutine exit</span>
   <span class="token keyword">if</span> in <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in channel closed return&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Working</span>
<span class="token comment">// in channel closed</span>
<span class="token comment">// in channel closed return</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_1-20-3-使用退出通道退出" tabindex="-1"><a class="header-anchor" href="#_1-20-3-使用退出通道退出" aria-hidden="true">#</a> 1.20.3. 使用退出通道退出</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;worker exit&quot;</span><span class="token punctuation">)</span>
  t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token comment">// Using stop channel explicit exit</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Recv stop signal&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>t<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Working .&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 stopCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>

 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
 <span class="token function">close</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>

 <span class="token comment">// Wait some print</span>
 time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main exit&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 显式关闭通道 stopCh 可以处理主动通知协程退出的场景。只要 main() 执行关闭 stopCh，每一个 worker 都会都到信号，进而关闭</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_1-20-4-总结" tabindex="-1"><a class="header-anchor" href="#_1-20-4-总结" aria-hidden="true">#</a> 1.20.4. 总结</h3><ol><li>发送协程主动关闭通道,接收协程不关闭通道.</li><li>协程处理1个通道,并且是读时,协程优先使用for-range,因为range可以关闭通道,自动退出协程.</li><li>_,ok可以处理多个读通道关闭,需要关闭当前使用for-select的协程.</li><li>显式关闭通道 stopCh 可以处理主动通知协程退出的场景。</li></ol><h2 id="_1-21-如何让所有子协程执行完后再执行主协程" tabindex="-1"><a class="header-anchor" href="#_1-21-如何让所有子协程执行完后再执行主协程" aria-hidden="true">#</a> 1.21. 如何让所有子协程执行完后再执行主协程</h2><p>子协程不会执行</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 子协程</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;son goroutine......&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 主协程</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main goroutine....&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_1-21-1-channel-实现同步" tabindex="-1"><a class="header-anchor" href="#_1-21-1-channel-实现同步" aria-hidden="true">#</a> 1.21.1. channel 实现同步</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 count <span class="token operator">:=</span> <span class="token number">2</span> <span class="token comment">// count 表示活动的协程个数</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine 1&quot;</span><span class="token punctuation">)</span>
  ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 协程结束，发出信号</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine 2&quot;</span><span class="token punctuation">)</span>
  ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 协程结束，发出信号</span>
 <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">for</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
  <span class="token comment">// 每次从ch中接收数据，表明一个活动的协程结束</span>
  count<span class="token operator">--</span>
  <span class="token comment">// 当所有活动的协程都结束时，关闭管道</span>
  <span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
   <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// count 表示有多少个协程</span>
<span class="token comment">// ch 用来子协程与主协程之间的同步</span>
<span class="token comment">// 主协程阻塞等待数据,每当一个子协程执行完后,就会往 ch 里面写一个数据,主协程收到后会使 count–,</span>
<span class="token comment">// 当 count 减为 0,关闭 ch,主协程将不阻塞在 range ch.</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_1-21-2-sync-waitgroup-实现等待" tabindex="-1"><a class="header-anchor" href="#_1-21-2-sync-waitgroup-实现等待" aria-hidden="true">#</a> 1.21.2. sync.WaitGroup 实现等待</h3><p>sync.WaitGroup 内部是实现了一个计数器,它有三个方法</p><ol><li>Add() 用来设置一个计数</li><li>Done() 用来在操作结束时调用,使计数减 1</li><li>Wait() 用来等待所有的操作结束,即计数变为 0.</li></ol><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token comment">// 使用 sync.WaitGroup 的方式来实现主协程等待其他子协程</span>

 <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
  wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 因为有两个动作，所以增加2个计数</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine 1&quot;</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 操作完成，减少一个计数</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Goroutine 2&quot;</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 操作完成，减少一个计数</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待，直到计数为0</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_1-22-知道哪些-sync-同步原语-各有什么作用" tabindex="-1"><a class="header-anchor" href="#_1-22-知道哪些-sync-同步原语-各有什么作用" aria-hidden="true">#</a> 1.22. 知道哪些 sync 同步原语?各有什么作用?</h2><p>sync 包中提供了用于同步的一些基本原语,包括常见的互斥锁 Mutex 与读写互斥锁 RWMutex 以及 Once,WaitGroup. 原语,一般是指由若干条指令组成的程序段,用来实现某个特定功能,在执行过程中不可被中断</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">6/13/2022, 11:35:16 AM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: shorestraydog@protonmail.com">shorestraydog</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: root@DESKTOP-VKU4PE6.localdomain">root</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/audition/golang/basic.html" class="nav-link" aria-label="1. basic"><!--[--><!--]--> 1. basic <!--[--><!--]--></a></span><span class="next"><a href="/audition/golang/distributed.html" class="nav-link" aria-label="1. distributed"><!--[--><!--]--> 1. distributed <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/audition/assets/js/runtime~app.d53e597b.js" defer></script><script src="/audition/assets/js/812.cf73d600.js" defer></script><script src="/audition/assets/js/app.44937fea.js" defer></script>
  </body>
</html>
